<!DOCTYPE html>
<html>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>中国隧道地图</title>
  <style type="text/css">
    html,body{margin:0px;height:100%;width:100%}
    .container{width:100%;height:100%}
    #contolbar{
      display: block;
      position: absolute;
      margin-top: 20px;
      margin-left: 20px;
      background:rgba(106, 185, 250, 0.5);
      z-index: 20000;
    }
    #controlbar input {
      background-color: rgba(106, 185, 250, 0.5);
      padding-top: 10px;
      padding-left: 20px;
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/maptalks/dist/maptalks.css">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/maptalks/dist/maptalks.min.js"></script>
  <script type="text/javascript" src="https://unpkg.com/maptalks.markercluster/dist/maptalks.markercluster.min.js"></script>
</script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdn.bootcss.com/sql.js/0.5.0/js/sql-optimized.js"></script>
  <script src="./tunnel.js"></script>
  <body>
    <div id="contolbar" style="width: 100;height: 800;">
      <label>按名称查找:</label><input type="text" placeholder="输入名称" name='searchname' onchange="searchbyname(this.value)">
      <label>按地点查找:</label><input type="text" placeholder="经度"><input type="text" placeholder="纬度">
    </div>
    <div id="map" class="container"></div>
    <script>
      var map = new maptalks.Map('map', {
        center: [120, 31.49856],
        zoom: 4,
        baseLayer: new maptalks.TileLayer('base', {
          'urlTemplate' : 'http://{s}.tile.osm.org/{z}/{x}/{y}.png',
          'subdomains'  : ['a','b','c'],
          'attribution' :  '&copy; <a target="_blank" href="http://openstreetmap.com">OSM</a>'
        })
      });
      var markers=[];
      for(var i=0;i<tunnels.length;i++){
                var position=[tunnels[i].location_lng,tunnels[i].location_lat];
                var marker = new maptalks.Marker(
                    position,
                    {
                    'properties' : {
                        'name' : tunnels[i].name
                    },
                    symbol : [
                        {
                        'markerFile'   : 'images/marker.png',
                        'markerWidth'  : 28,
                        'markerHeight' : 40
                        },
                        {
                        'textFaceName' : 'sans-serif',
                        'textName' : '{name}',
                        'textSize' : 14,
                        'textDy'   : 24
                        }
                    ]
                    }
                ).on('mousedown', onClick);
                markers.push(marker);
            }
        // 点聚合图层
        var clusterLayer = new maptalks.ClusterLayer('cluster', markers, {
        'noClusterWithOneMarker' : false,
        'maxClusterZoom' : 18,
        //"count" is an internal variable: marker count in the cluster.
        'symbol': {
            'markerType' : 'ellipse',
            'markerFill' : { property:'count', type:'interval', stops: [[0, 'rgb(135, 196, 240)'], [9, '#1bbc9b'], [99, 'rgb(216, 115, 149)']] },
            'markerFillOpacity' : 0.7,
            'markerLineOpacity' : 1,
            'markerLineWidth' : 3,
            'markerLineColor' : '#fff',
            'markerWidth' : { property:'count', type:'interval', stops: [[0, 40], [9, 60], [99, 80]] },
            'markerHeight' : { property:'count', type:'interval', stops: [[0, 40], [9, 60], [99, 80]] }
        },
        'drawClusterText': true,
        'geometryEvents' : true,
        'single': true
    });
    clusterLayer.config('maxClusterRadius',100);
    clusterLayer.config('maxClusterZoom',12);
    map.addLayer(clusterLayer);

    map.on('click', function (e) {
        console.log(clusterLayer.identify(e.coordinate));
    });
    function onClick(e) {
        console.log('点击',e.target);
        var tunnel=searchbynamelocation(e.target.properties.name,e.target._coordinates.y,e.target._coordinates.x);
        if(tunnel==undefined){
          alert('抱歉，未找该隧道！');
        }else{
          alert(tunnel.name+':位于'+tunnel.province+tunnel.city+tunnel.area+'\n'+'经度:'+tunnel.location_lng+',纬度:'+tunnel.location_lat)
        }
      }

    function searchbyname(name){
      var t=tunnels;
      console.log('searching',name);
      var site=t.find((el)=> el.name==name);
      console.log(site)
      changeView(site.location_lat,site.location_lng)
      return site;
    }
    function searchbynamelocation(name,location_lat,location_lng){
      var t=tunnels;
      console.log('searching',name,location_lat,location_lng)
      var site=t.find((el)=> el.name==name ||(el.location_lat==location_lat && el.location_lng==location_lng))
      return site;
    }
    
    function changeView(location_lat,location_lng) {
        map.animateTo({
          center: [location_lng, location_lat],
          zoom: 14,
          pitch: 0,
          bearing: 20
        }, {
          duration: 6000
        });}
    </script>
  </body>
</html>